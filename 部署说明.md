# 证书生成系统优化部署说明

## 优化概述

本次优化将原来的"分别下载docx zip和PDF"改为"下载单一完整压缩包"，压缩包包含：
- 所有Word证书文件
- 最终合并的PDF文件
- 智能命名：`委托单位名称_检测日期.zip`

## 前端更改（已完成）

### 1. API路由更新 (`src/app/api/generate-certificates/route.ts`)
- ✅ 添加压缩包名称生成逻辑
- ✅ 新增`completeZipUrl`和`zipFileName`返回字段
- ✅ 后台异步调用新增`/package/{taskId}`接口

### 2. 前端页面更新 (`src/app/new-project/page.tsx`)
- ✅ 添加`completeZipUrl`和`zipFileName`状态变量
- ✅ 更新下载按钮为单一完整压缩包下载
- ✅ 优化进度显示，支持多阶段处理（转换→合并→打包）

## Windows服务器更改（需要实施）

### 1. 新增Flask API接口

需要在Windows服务器的Flask应用中添加以下接口：

#### A. `/package/<task_id>` (POST)
```python
@app.route('/package/<task_id>', methods=['POST'])
def package_complete_files(task_id):
    # 生成包含所有docx文件和合并PDF的完整压缩包
    # 详见 flask_server_updates.py 文件
```

#### B. `/download/<task_id>/complete` (GET)
```python
@app.route('/download/<task_id>/complete', methods=['GET'])
def download_complete_package(task_id):
    # 提供完整压缩包下载
    # 支持自定义文件名参数
```

#### C. 更新 `/progress/<task_id>` (GET)
```python
@app.route('/progress/<task_id>', methods=['GET'])
def get_progress(task_id):
    # 添加package_done状态
    # 支持三阶段进度：转换→合并→打包
```

### 2. 文件结构调整

在Windows服务器上，任务文件结构应为：
```
tasks/
├── {task_id}/
│   ├── docx/           # 原始docx文件
│   ├── pdf/            # 转换后的PDF文件
│   ├── merged/         # 合并后的PDF文件
│   └── complete/       # 完整压缩包
│       └── {委托单位}_{日期}.zip
```

### 3. 依赖包安装

确保Windows服务器已安装必要的Python包：
```bash
pip install flask flask-cors zipfile
```

## 部署步骤

### 第一步：更新Flask服务器代码
1. 将`flask_server_updates.py`中的代码集成到现有Flask应用
2. 确保新增的三个接口正常工作
3. 测试文件打包和下载功能

### 第二步：重启Flask服务
```bash
# 如果使用NSSM管理服务
nssm restart FlaskCertificateService

# 或者直接重启Python进程
```

### 第三步：测试完整流程
1. 在前端生成证书
2. 观察进度条是否显示三个阶段
3. 确认最终下载的是完整压缩包
4. 验证压缩包内容包含所有docx文件和PDF文件

## 压缩包命名规则

### 示例
- 委托单位：绍兴某某公司
- 检测日期：2024年01月15日
- 生成的压缩包名：`绍兴某某公司_2024_01_15.zip`

### 命名逻辑
```javascript
const [date_now] = formatDate(String(date));
const zipFileName = `${companyName}_${date_now.replace(/\s/g, '').replace(/年|月|日/g, '_')}.zip`;
```

## 用户体验改进

### 1. 进度显示优化
- **阶段1 (0-60%)**：正在处理第X/Y个文件：文件名
- **阶段2 (60-70%)**：正在合并PDF文件...
- **阶段3 (70-85%)**：正在生成完整压缩包...
- **完成 (100%)**：所有处理完成，可以下载了！

### 2. 下载按钮优化
- 绿色主题，突出完整性
- 显示压缩包文件名
- 添加说明文字："包含所有Word证书文件和合并后的PDF文件"

## 错误处理

### 1. 压缩包生成失败
- Flask服务器返回500错误
- 前端显示"生成完整压缩包失败"

### 2. 下载文件不存在
- Flask服务器返回404错误
- 前端提示"完整压缩包不存在，请稍后重试"

### 3. 进度查询异常
- 连续失败2次后停止轮询
- 显示"进度查询异常，请刷新页面或稍后重试"

## 清理机制（可选）

建议在Flask服务器中添加定时清理机制：
- 清理超过24小时的任务文件
- 释放服务器存储空间
- 详见`flask_server_updates.py`中的`cleanup_old_tasks`函数

## 测试检查清单

- [ ] 前端能正确生成压缩包名称
- [ ] Flask服务器能接收打包请求
- [ ] 压缩包包含所有docx文件
- [ ] 压缩包包含合并后的PDF文件
- [ ] 下载链接正常工作
- [ ] 进度条显示三个阶段
- [ ] 错误处理正常工作
- [ ] 文件清理机制正常（如果启用）

## 回滚方案

如果新功能出现问题，可以快速回滚：
1. 注释掉Flask服务器中的新接口
2. 前端恢复显示两个下载按钮
3. 重启Flask服务

回滚时需要修改的文件：
- `src/app/api/generate-certificates/route.ts`
- `src/app/new-project/page.tsx` 